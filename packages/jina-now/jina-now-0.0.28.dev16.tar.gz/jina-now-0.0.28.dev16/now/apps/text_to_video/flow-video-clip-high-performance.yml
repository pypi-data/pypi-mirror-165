jtype: Flow
with:
  name: nowapi
  monitoring: true
  port_expose: 8080
  prefetch: 30
  cors: True
jcloud:
  version: 3.7.0
  retention_days: ${{ RETENTION_DAYS }}
executors:
  - name: preprocessor
    uses: ${{ ENV.PREPROCESSOR_NAME }}
    replicas: 5
    uses_with:
      app: ${{ ENV.APP }}
    jcloud:
      capacity: on-demand
      resources:
        cpu: 2.0
        memory: 2G
    env:
      JINA_LOG_LEVEL: DEBUG
  - name: encoder_clip
    replicas: 3
    uses: ${{ ENV.ENCODER_NAME }}
    replicas: 3
    jcloud:
      capacity: on-demand
      resources:
        cpu: 2.0
        memory: 4G
        gpu: ${{ ENV.GPU }}
    uses_with:
      pretrained_model_name_or_path: ${{ ENV.PRE_TRAINED_MODEL_NAME }}
      traversal_paths: '@c'
      device: ${{ ENV.DEVICE }}
    env:
      JINA_LOG_LEVEL: DEBUG
  - name: postprocessor
    uses: jinahub+docker://NOWPostprocessor/v0.0.5
    uses_with:
      traversal_paths: '@c'
    jcloud:
      capacity: on-demand
    env:
      JINA_LOG_LEVEL: DEBUG
  - name: indexer
    uses: ${{ ENV.INDEXER_NAME }}
    uses_with:
      traversal_paths: '@c'
      index_traversal_paths: '@c'
      search_traversal_paths: '@c'
      dim: ${{ ENV.PRE_TRAINED_EMBEDDINGS_SIZE }}
    jcloud:
      capacity: on-demand
      resources:
        memory: 4G
        cpu: 1.0
    env:
      JINA_LOG_LEVEL: DEBUG