#!/usr/bin/env python3
# This file is placed in the Public Domain.
# pylint: disable=E1101,E0611,C0115,C0116,C0413,C0411,W0406


"Prosecutor. Court. Reconsider OTP-CR-117/19."


import importlib
import os
import readline
import sys
import termios


sys.path.insert(0, os.getcwd())


from gcid.client import Client
from gcid.event import Event
from gcid.parse import parse
from gcid.irc import IRC
from gcid.model import init
from gcid.rss import Fetcher
from gcid.run import docmd
from gcid.scan import scan, scandir
from gcid.workdir import Wd


Wd.workdir = os.path.expanduser("~/.gcid")


class CLI(Client):

    @staticmethod
    def raw(txt):
        print(txt)
        sys.stdout.flush()


class Console(CLI):

    @staticmethod
    def handle(event):
        Client.handle(event)
        event.wait()

    def poll(self):
        event = Event()
        event.txt = input("> ")
        event.orig = repr(self)
        return event


def importer(packagename, modulename):
    name = "%s.%s" % (packagename, modulename)
    mod = importlib.import_module(name, packagename)
    scan(mod)


def wrap(func):
    fds = sys.stdin.fileno()
    gotterm = True
    try:
        old = termios.tcgetattr(fds)
    except termios.error:
        gotterm = False
    readline.redisplay()
    try:
        func()
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        if gotterm:
            termios.tcsetattr(fds, termios.TCSADRAIN, old)


def main():
    txt = ' '.join(sys.argv[1:])
    cfg = parse(txt)
    scandir("gcid", importer)
    if cfg.txt:
        cli = CLI()
        docmd(cli, cfg.otxt)
    elif "c" in cfg.opts:
        bot = IRC()
        bot.start()
        fetcher = Fetcher()
        fetcher.start()
        init()
        csl = Console()
        csl.start()
        csl.forever()


wrap(main)
